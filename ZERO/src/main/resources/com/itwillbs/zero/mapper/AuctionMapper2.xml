<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.itwillbs.zero.mapper.AuctionMapper2">
	<select id="selectCategoryList" resultType="hashmap">
		SELECT * FROM CATEGORY
		WHERE category_type = '경매'
	</select>
	
	<select id="selectBrandList" resultType="hashmap">
		SELECT * FROM BRAND
	</select>

	<insert id="insertProduct" >
	<selectKey keyProperty="auction_idx" resultType="int" order="AFTER">
			SELECT MAX(auction_idx)
				FROM AUCTION_PRODUCT
				
	</selectKey>
		INSERT
			INTO AUCTION_PRODUCT
			VALUES (
				null 
				, #{auction_title} 
				, #{auction_start_price} 
				, #{category_idx} 
				, #{auction_product_status}  
				, #{auction_max_price} 
				, #{auction_content} 
				, #{board_file1}   
				, #{board_file2}   
				, #{board_file3}   
				, now()
				, #{brand_idx} 
				, #{auction_seller_id} 
				, #{auction_seller_address} 
				, #{auction_seller_address_detail} 
			)
	</insert>
	
	<insert id="insertAuctionManaging" >
	
		INSERT 
		INTO AUCTION_MANAGING
		(auction_managing_idx, auction_idx, auction_manage_check_status,member_id)
		values(
			null
			,#{auction_idx}
			,'등록'
			,null
			)
	</insert>
	
	<select id="selectAuctionProduct" resultType="hashmap">
		SELECT *FROM AUCTION_PRODUCT ap  JOIN AUCTION_MANAGING am 
		ON ap.auction_idx = am.auction_idx
		WHERE ap.auction_idx=#{id}
	</select>

	<insert id="insertLog" >
	
		INSERT 
		INTO AUCTION_LOG_ROOM
		values(
			null
			, #{auction_log_bid}
			, now()
			, #{member_id}
			, #{auction_idx}
			)
	</insert>
	<select id="selectAuctionLog" resultType="hashmap">
		SELECT *from AUCTION_LOG_ROOM
		WHERE auction_idx=#{id}
		ORDER BY auction_log_bid
	</select>

	
	<select id="selectMaxPrice" resultType="int">
		SELECT IFNULL(max(auction_log_bid),0) FROM AUCTION_LOG_ROOM
		WHERE auction_idx=#{auction_idx}
	</select>
	
	<update id="updateEnd" >
		UPDATE AUCTION_MANAGING SET auction_manage_status='경매종료' WHERE auction_end_datetime =#{now}  
	</update>
	
	<select id="selectWinnerList" resultType="hashmap">
		SELECT a.auction_idx, a.max_bid, b.member_id FROM
		  (SELECT auction_idx, MAX(auction_log_bid) as max_bid
		   FROM AUCTION_LOG_ROOM
		   GROUP BY auction_idx) as a
		JOIN AUCTION_LOG_ROOM as b
		  ON a.auction_idx = b.auction_idx AND a.max_bid = b.auction_log_bid
		JOIN AUCTION_MANAGING as am
		  ON a.auction_idx = am.auction_idx
		WHERE auction_end_datetime =#{now} AND am.member_id IS NULL
	</select>
	
	<update id="updateWinner" >
		UPDATE AUCTION_MANAGING SET member_id =#{member_id} WHERE auction_idx =#{auction_idx} 
	</update>
	
</mapper>
