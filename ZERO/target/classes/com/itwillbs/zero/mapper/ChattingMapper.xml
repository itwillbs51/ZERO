<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.itwillbs.zero.mapper.ChattingMapper">
	
	
	<!-- 채팅방 조회 -  SELECT -->
	<!-- 세션아이디로 조회해서 현재 열려있는 채팅방을 List로 반환받기 -->
	<select id="selectChatRoomList" resultType="ChatRoomList">
		SELECT
			chat_room_idx
			, buyer_id
			, seller_id
			, secondhand_idx
			, secondhand_image1
			, buyer_nickname
			, buyer_image
			, seller_nickname
			, seller_image
			, chat_content
			, chat_time_fromNow
			FROM
				CHATROOMLIST
			WHERE
				seller_id = #{member_id}
				OR buyer_id = #{member_id}
	</select>
		<!-- 나중에 페이징처리하기(무한 스크롤) -->	
	
	<!-- 채팅 조회 - SELECT -->
	<select id="selectChatList" resultType="Chat">
		SELECT *
			FROM
				( SELECT *
					FROM
						CHAT
					WHERE
						chat_room_idx = #{chat_room_idx}
					ORDER BY
						chat_idx DESC
					LIMIT 15
					) AS SUB
			ORDER BY
				chat_idx
	</select>
		<!-- 나중에 페이징 처리하기(무한 스크롤) -->
	
	<!-- 채팅 내용 삽입 - INSERT -->
	<insert id="insertChat">
		INSERT
			INTO CHAT
			VALUES
				(
				null		-- chat_idx
				, now()		-- chat_datetime
				, #{chat_content}		-- chat_content
				, #{chat_content_type}		-- chat_content_type
				, #{chat_room_idx}		-- chat_room_idx
				, #{member_id}		-- member_id
				)
	
	</insert>
	
	<!-- 채팅방 번호 찾기 -->
	<select id="selectChatRoomIdx" resultType="int">
		SELECT
			IFNULL(MAX(chat_room_idx), 0)
			FROM
				CHAT_ROOM
			WHERE
				seller_id = #{map.seller_id}
				AND 
					buyer_id = #{buyer_id}
				AND
					secondhand_idx = #{map.secondhand_idx}
	</select>
	
	<!-- 채팅방 생성하기 -->
	<insert id="insertChatRoom">
		INSERT
			INTO CHAT_ROOM
			VALUES
				(
				null
				, #{map.seller_id}
				, #{buyer_id}
				, #{map.secondhand_idx}
				)
	</insert>
	
	<!--  -->
	<select id="selectSecondhandIdx" resultType="int">
		SELECT
			secondhand_idx
			FROM
				CHAT_ROOM
			WHERE
				chat_room_idx = #{chat_room_idx}
	</select>
	
	
</mapper>
