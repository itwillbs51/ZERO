<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.itwillbs.zero.mapper.ZpayMapper">

	<!-- ZPAY 사용자 여부 조회 -->
	<select id="selectZpay" resultType="com.itwillbs.zero.vo.ZpayVO">
		SELECT * FROM ZPAY
		WHERE member_id = #{member_id}
	</select>
	
	<!-- ZPAY 등록 -->
	<insert id="insertZpay">
		INSERT INTO ZPAY
			VALUES (
				null
				, #{zpay_bank_name}
				, #{zpay_bank_account}
				, 0
				, #{member_id}
				, #{fintech_use_num}
				, #{access_token}
			)
	</insert>
	
	<!-- ZPAY 잔액 조회 -->
	<select id="selectZpayBalance" resultType="Integer">
		SELECT ifnull(zpay_balance, 0)
			FROM ZPAY_HISTORY
			WHERE zpay_history_idx 
					= (SELECT MAX(zpay_history_idx) FROM ZPAY_HISTORY WHERE member_id = #{member_id})
	</select>
	
	<!-- ZPAY 사용 내역(목록) 조회 -->
	<select id="selectZpayHistory" resultType="com.itwillbs.zero.vo.ZpayHistoryVO">
		SELECT * FROM ZPAY_HISTORY
		WHERE member_id = #{member_id}
		ORDER BY zpay_time DESC
	</select>
	
	<!-- ZPAY 번호 조회 -->
	<select id="selectZpayIdx" resultType="int">
		SELECT * FROM ZPAY
		WHERE member_id = #{member_id}
	</select>
	
	<!-- ZPYA_HISTORY 테이블에 충전내역 추가 -->
	<insert id="insertChargeHistory">
		INSERT INTO 
			ZPAY_HISTORY(
				zpay_history_idx
				, zpay_idx
				, zpay_amount
				, zpay_time
				, zpay_balance
				, zpay_deal_type
				, member_id)
			VALUES(
				null
				, #{zpay_idx}
				, #{zpay_amount} * 1.01
				, now()
				, #{zpay_balance} + #{zpay_amount} * 1.01
				, #{zpay_deal_type}
				, #{member_id}
			)		
	</insert>

	<!-- ZPYA_HISTORY 테이블에 충전내역 추가 -->
	<insert id="insertRefundHistory">
		INSERT INTO 
			ZPAY_HISTORY(
				zpay_history_idx
				, zpay_idx
				, zpay_amount
				, zpay_time
				, zpay_balance
				, zpay_deal_type
				, member_id)
			VALUES(
				null
				, #{zpay_idx}
				, #{zpay_amount}
				, now()
				, #{zpay_balance} - #{zpay_amount}
				, "환급"
				, #{member_id}
			)		
	</insert>
	
	<!-- 중고거래 내역 조회 -->
	<select id="selectOrderSecondhand" resultType="com.itwillbs.zero.vo.OrderSecondhandVO">
		SELECT * FROM ORDER_SECONDHAND
		WHERE order_secondhand_idx = #{order_secondhand_idx}
		AND order_secondhand_iszpay = 'Y'
	</select>
	
	<!-- ZPYA_HISTORY 테이블에 송금내역 추가 -->
	<insert id="insertSendHistory">
		INSERT INTO 
			ZPAY_HISTORY(
				zpay_history_idx
				, zpay_idx
				, zpay_amount
				, zpay_time
				, zpay_balance
				, zpay_deal_type
				, member_id)
			VALUES(
				null
				, #{zpay_idx}
				, #{zpay_amount}
				, now()
				, #{zpay_balance} - #{zpay_amount}
				, '중고출금'
				, #{member_id}
			)		
	</insert>

	<!-- ZPYA_HISTORY 테이블에 수취내역 추가 -->
	<insert id="insertReceiveHistory">
		INSERT INTO 
			ZPAY_HISTORY(
				zpay_history_idx
				, zpay_idx
				, zpay_amount
				, zpay_time
				, zpay_balance
				, zpay_deal_type
				, member_id)
			VALUES(
				null
				, #{zpay_idx}
				, #{zpay_amount}
				, now()
				, #{zpay_balance} + #{zpay_amount}
				, "중고입금"
				, #{member_id}
			)		
	</insert>
	
	
	<!--  -->
	<select id="selectZpayHistoryListCount" resultType="int">
		SELECT COUNT(*)
			FROM ZPAY_HISTORY
				WHERE
					member_id = #{member_id}
<!-- 					<if test="!searchKeyword.equals('')"> -->
<!-- 						AND -->
<!-- 						<choose> -->
<!-- 							<when test="searchType.equals('subject')"> -->
<!-- 								board_subject LIKE CONCAT('%', #{searchKeyword} ,'%') -->
<!-- 							</when> -->
<!-- 							<when test="searchType.equals('content')"> -->
<!-- 								board_content LIKE CONCAT('%', #{searchKeyword} ,'%') -->
<!-- 							</when> -->
<!-- 							<when test="searchType.equals('subject_content')"> -->
<!-- 								board_subject LIKE CONCAT('%', #{searchKeyword} ,'%')  -->
<!-- 								OR board_content LIKE CONCAT('%', #{searchKeyword} ,'%')  -->
<!-- 							</when> -->
<!-- 							<when test="searchType.equals('name')"> -->
<!-- 								board_name LIKE CONCAT('%', #{searchKeyword} ,'%') -->
<!-- 							</when> -->
<!-- 						</choose> -->
<!-- 					</if> -->
	</select>
	
	<select id="selectZpayHistoryList" resultType="com.itwillbs.zero.vo.ZpayHistoryVO">
		SELECT *
			FROM ZPAY_HISTORY
				WHERE
					member_id = #{member_id}
				<if test="!searchType.equals('')">
					<choose>
						<when test="searchType.equals('충전')">
							AND zpay_deal_type = '충전'
						</when>
						<when test="searchType.equals('환급')">
							AND zpay_deal_type = '환급'
						</when>
						<when test="searchType.equals('사용')">
							AND zpay_deal_type = '중고출금'
							OR zpay_deal_type = '경매출금'
						</when>
						<when test="searchType.equals('수익')">
							AND zpay_deal_type = '중고입금'
							OR zpay_deal_type = '경매입금'
						</when>
					</choose>
				</if>
			ORDER BY 
				zpay_time DESC
<!-- 			LIMIT -->
<!-- 				#{startRow} -->
<!-- 				, #{listLimit} -->
	</select>
	
</mapper>
